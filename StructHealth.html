import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, setDoc, collection, onSnapshot, updateDoc, deleteDoc, addDoc } from 'firebase/firestore';
import { ChevronRight, ChevronLeft, ChevronDown, Plus, Check, Activity, Utensils, Moon, Settings, Trash2, FolderPlus, FilePlus } from 'lucide-react';

// === Firebase 初始化 ===
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'struct-health-tree';

export default function App() {
  const [user, setUser] = useState(null);
  const [view, setView] = useState('dashboard'); // dashboard, execution, pillar-detail
  const [activePillarId, setActivePillarId] = useState(null); // 當前進入的支柱 ID
  const [loading, setLoading] = useState(true);

  // 狀態
  const [goals, setGoals] = useState([]);
  const [pillars, setPillars] = useState([]);
  const [tasks, setTasks] = useState([]);

  // Auth Init
  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, (u) => {
      setUser(u);
      setLoading(false);
    });
    return () => unsubscribe();
  }, []);

  // 資料監聽與預設初始化
  useEffect(() => {
    if (!user) return;

    const goalsRef = collection(db, 'artifacts', appId, 'users', user.uid, 'goals');
    const pillarsRef = collection(db, 'artifacts', appId, 'users', user.uid, 'pillars');
    const tasksRef = collection(db, 'artifacts', appId, 'users', user.uid, 'tasks');

    const unsubGoals = onSnapshot(goalsRef, (snap) => setGoals(snap.docs.map(d => ({ id: d.id, ...d.data() }))));
    const unsubTasks = onSnapshot(tasksRef, (snap) => setTasks(snap.docs.map(d => ({ id: d.id, ...d.data() }))));
    
    const unsubPillars = onSnapshot(pillarsRef, async (snap) => {
      if (snap.empty) {
        // 若完全沒資料，自動建立預設的三大支柱
        const defaults = [
          { id: 'p1', title: '身體組成追蹤', icon: 'Activity', nodes: [] },
          { id: 'p2', title: '營養代謝追蹤', icon: 'Utensils', nodes: [] },
          { id: 'p3', title: '睡眠與恢復追蹤', icon: 'Moon', nodes: [] }
        ];
        for (const p of defaults) {
          await setDoc(doc(pillarsRef, p.id), p);
        }
      } else {
        // 保證排序 (以 ID 排序維持順序)
        const loadedPillars = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => a.id.localeCompare(b.id));
        setPillars(loadedPillars);
      }
    });

    return () => { unsubGoals(); unsubTasks(); unsubPillars(); };
  }, [user]);

  // 全局輔助函數：生成唯一ID
  const generateId = () => Math.random().toString(36).substr(2, 9);

  if (loading) return <div className="flex h-screen items-center justify-center bg-white text-slate-400 font-bold tracking-widest">載入中...</div>;

  return (
    <div className="flex h-[100dvh] w-full flex-col bg-gray-50 text-slate-900 overflow-hidden font-sans">
      <main className="relative mx-auto h-full w-full max-w-md bg-white shadow-2xl overflow-hidden flex flex-col">
        
        {/* Header */}
        <header className="flex items-center justify-between p-6 bg-white shrink-0 sticky top-0 z-20">
          <div className="flex items-center gap-2">
            <div className="rounded-xl bg-slate-900 p-2 text-white">
              <Activity size={20} />
            </div>
            <h1 className="text-xl font-black tracking-tight">StructHealth</h1>
          </div>
          <div className="flex h-8 w-8 items-center justify-center rounded-full bg-slate-100 text-xs font-bold text-slate-400">
            {user?.uid.substring(0, 2).toUpperCase()}
          </div>
        </header>

        {/* 核心內容區 */}
        <div className="flex-1 overflow-y-auto pb-24 px-6 space-y-8 no-scrollbar">
          {view === 'dashboard' && <DashboardView goals={goals} pillars={pillars} user={user} setView={setView} setActivePillarId={setActivePillarId} tasks={tasks} />}
          {view === 'execution' && <ExecutionView tasks={tasks} user={user} generateId={generateId} />}
          {view === 'pillar-detail' && <TreePillarView pillar={pillars.find(p => p.id === activePillarId)} user={user} setView={setView} generateId={generateId} />}
        </div>

        {/* 底部導覽列 */}
        <nav className="fixed bottom-0 left-0 right-0 mx-auto flex h-16 max-w-md items-center justify-around border-t border-slate-100 bg-white/90 backdrop-blur-md z-30 px-4">
          <NavBtn active={view === 'dashboard'} onClick={() => setView('dashboard')} icon={<Activity size={22} />} label="概覽" />
          <NavBtn active={view === 'execution'} onClick={() => setView('execution')} icon={<Check size={22} />} label="執行" />
          <NavBtn active={false} onClick={() => {}} icon={<Plus size={24} className="text-white bg-slate-900 rounded-full p-1 shadow-md" />} label="新增" />
          <NavBtn active={false} onClick={() => {}} icon={<Settings size={22} />} label="設定" />
        </nav>
      </main>
    </div>
  );
}

const NavBtn = ({ active, onClick, icon, label }) => (
  <button onClick={onClick} className={`flex flex-col items-center gap-1 transition-colors ${active ? 'text-slate-900' : 'text-slate-400'}`}>
    {icon}
    <span className="text-[9px] font-black uppercase tracking-widest">{label}</span>
  </button>
);

// ==========================================
// 視圖一：概覽 (Dashboard)
// ==========================================
const DashboardView = ({ goals, pillars, user, setView, setActivePillarId, tasks }) => {
  const addGoal = async () => {
    const title = prompt('輸入新目標名稱 (例如: 攀岩 V5)');
    if (!title) return;
    await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'goals'), { title, progress: 0 });
  };

  const updateGoal = async (id, currentProgress) => {
    const newProgress = prompt('輸入目前進度 %', currentProgress);
    if (newProgress === null) return;
    const progress = Math.min(100, Math.max(0, parseInt(newProgress) || 0));
    await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'goals', id), { progress });
  };

  const deleteGoal = async (id) => {
    if (confirm('確定刪除此目標？')) await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'goals', id));
  };

  // 簡單計算今日任務完成率 (供日曆視覺模擬使用)
  const todayTasks = tasks.filter(t => t.completed);
  const todayScore = tasks.length > 0 ? (todayTasks.length / tasks.length) : 0;

  return (
    <div className="space-y-8 py-4">
      {/* 1. 進行中目標 */}
      <section className="space-y-4">
        <div className="flex items-end justify-between px-1">
          <h2 className="text-[10px] font-black uppercase tracking-widest text-slate-400">1. 進行中目標</h2>
          <button onClick={addGoal} className="text-[10px] font-bold text-slate-900 bg-slate-100 px-2 py-1 rounded">＋ 新增目標</button>
        </div>
        <div className="grid gap-3">
          {goals.length > 0 ? goals.map(g => (
            <div key={g.id} className="rounded-3xl border border-slate-100 bg-white p-5 shadow-sm relative group">
              <button onClick={() => deleteGoal(g.id)} className="absolute top-4 right-4 text-slate-200 hover:text-red-400 hidden group-hover:block"><Trash2 size={14} /></button>
              <div className="mb-3 flex items-start justify-between cursor-pointer pr-6" onClick={() => updateGoal(g.id, g.progress)}>
                <div>
                  <h3 className="font-bold text-slate-800">{g.title}</h3>
                  <p className="text-[9px] text-slate-400 mt-1 uppercase font-black tracking-tighter">點擊更新進度</p>
                </div>
                <span className="font-mono text-sm font-bold text-slate-900">{g.progress}%</span>
              </div>
              <div className="h-1.5 w-full rounded-full bg-slate-100 overflow-hidden">
                <div className="h-full bg-slate-900 transition-all" style={{ width: `${g.progress}%` }}></div>
              </div>
            </div>
          )) : (
            <div className="p-6 text-center border-2 border-dashed border-slate-100 rounded-3xl text-slate-300 text-xs font-bold">尚無目標，點擊右上角新增</div>
          )}
        </div>
      </section>

      {/* 2. 三大支柱追蹤 */}
      <section className="space-y-4">
        <h2 className="text-[10px] font-black uppercase tracking-widest text-slate-400 px-1">2. 支柱狀態總覽</h2>
        <div className="space-y-3">
          {pillars.map(pillar => {
            // 遞迴計算此支柱下的總節點數，僅作簡單摘要
            let count = 0;
            const countNodes = (nodes) => { nodes.forEach(n => { count++; if(n.children) countNodes(n.children); }); };
            if (pillar.nodes) countNodes(pillar.nodes);

            const IconComponent = pillar.icon === 'Utensils' ? Utensils : pillar.icon === 'Moon' ? Moon : Activity;
            
            return (
              <div key={pillar.id} onClick={() => { setActivePillarId(pillar.id); setView('pillar-detail'); }}
                   className="flex cursor-pointer items-center gap-4 rounded-3xl border border-slate-100 bg-white p-5 shadow-sm transition-all hover:bg-slate-50 active:scale-95">
                <div className="flex h-12 w-12 items-center justify-center rounded-2xl shrink-0 bg-slate-50 text-slate-700">
                  <IconComponent size={20} />
                </div>
                <div className="flex-1">
                  <h3 className="font-bold text-sm text-slate-800">{pillar.title}</h3>
                  <p className="text-[10px] text-slate-400 mt-1 uppercase font-bold tracking-tighter">已建立 {count} 項追蹤節點</p>
                </div>
                <ChevronRight size={16} className="text-slate-200" />
              </div>
            )
          })}
        </div>
      </section>

      {/* 3. 完程度日曆 (0-3 點) */}
      <section className="space-y-4">
        <h2 className="text-[10px] font-black uppercase tracking-widest text-slate-400 px-1">3. 完程度日曆</h2>
        <div className="rounded-3xl border border-slate-100 bg-white p-6 shadow-sm">
          <div className="mb-6 grid grid-cols-7 gap-2 text-center text-[10px] font-black uppercase tracking-tighter text-slate-300">
            {['M', 'T', 'W', 'T', 'F', 'S', 'S'].map((d, idx) => <div key={idx}>{d}</div>)}
          </div>
          <div className="grid grid-cols-7 gap-y-4 gap-x-2">
            {[...Array(28)].map((_, i) => {
              // 模擬過去的紀錄，若是最後一天則使用今日真實分數
              const isToday = i === 27;
              let dayScore = isToday ? todayScore : Math.random(); 
              
              // 決定 0-3 個點
              let dotCount = 0;
              if (dayScore > 0.8) dotCount = 3;
              else if (dayScore > 0.4) dotCount = 2;
              else if (dayScore > 0.1) dotCount = 1;

              return (
                <div key={i} className="flex flex-col items-center gap-1">
                  <div className={`text-xs font-bold ${isToday ? 'text-slate-900 bg-slate-100 w-6 h-6 rounded-full flex items-center justify-center' : 'text-slate-400'}`}>
                    {i + 1}
                  </div>
                  <div className="flex gap-0.5 h-1">
                    {Array.from({length: 3}).map((_, dotIdx) => (
                      <div key={dotIdx} className={`w-1 h-1 rounded-full ${dotIdx < dotCount ? 'bg-slate-800' : 'bg-transparent'}`} />
                    ))}
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      </section>
    </div>
  );
};

// ==========================================
// 視圖二/三/四：無限層級樹狀結構 (Tree Pillar View)
// ==========================================
const TreePillarView = ({ pillar, user, setView, generateId }) => {
  if (!pillar) return null;

  // --- 樹狀資料操作核心邏輯 ---
  const saveTree = async (newNodes) => {
    await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'pillars', pillar.id), { nodes: newNodes });
  };

  const traverseAndUpdate = (nodes, targetId, updaterFn) => {
    return nodes.map(node => {
      if (node.id === targetId) return updaterFn(node);
      if (node.children) return { ...node, children: traverseAndUpdate(node.children, targetId, updaterFn) };
      return node;
    });
  };

  const traverseAndDelete = (nodes, targetId) => {
    return nodes.filter(n => n.id !== targetId).map(n => ({
      ...n, children: n.children ? traverseAndDelete(n.children, targetId) : undefined
    }));
  };

  // --- 動作處理 ---
  const handleAddChild = (parentId, type) => {
    const name = prompt(`輸入${type === 'folder' ? '分類' : '項目'}名稱`);
    if (!name) return;

    let newNode = { id: generateId(), name, type };
    if (type === 'leaf') {
      const target = prompt('設定目標數值 (數字)', '100');
      const unit = prompt('輸入單位 (如 kg, kcal, hrs)', '');
      newNode = { ...newNode, current: 0, target: parseFloat(target) || 0, unit: unit || '' };
    } else {
      newNode.children = [];
    }

    if (parentId === 'root') {
      saveTree([...(pillar.nodes || []), newNode]);
    } else {
      const updatedNodes = traverseAndUpdate(pillar.nodes, parentId, (node) => ({
        ...node, children: [...(node.children || []), newNode]
      }));
      saveTree(updatedNodes);
    }
  };

  const handleDelete = (id) => {
    if (!confirm('確定刪除此節點與其所有子項目？')) return;
    saveTree(traverseAndDelete(pillar.nodes, id));
  };

  const handleUpdateLeaf = (id, field, value) => {
    const updatedNodes = traverseAndUpdate(pillar.nodes, id, (node) => ({
      ...node, [field]: parseFloat(value) || 0
    }));
    saveTree(updatedNodes);
  };

  return (
    <div className="space-y-6 py-4">
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-3">
          <button onClick={() => setView('dashboard')} className="p-2 bg-slate-50 rounded-full text-slate-400"><ChevronLeft size={20} /></button>
          <h2 className="text-xl font-black">{pillar.title}</h2>
        </div>
        <div className="flex gap-2">
          <button onClick={() => handleAddChild('root', 'folder')} className="p-2 bg-slate-100 text-slate-700 rounded-lg hover:bg-slate-200" title="新增大分類"><FolderPlus size={18}/></button>
          <button onClick={() => handleAddChild('root', 'leaf')} className="p-2 bg-slate-900 text-white rounded-lg shadow-md" title="新增根項目"><FilePlus size={18}/></button>
        </div>
      </div>

      <div className="rounded-3xl border border-slate-100 bg-white p-5 shadow-sm min-h-[60vh]">
        {(!pillar.nodes || pillar.nodes.length === 0) && (
          <div className="text-center p-8 text-slate-400 text-xs font-bold border-2 border-dashed border-slate-100 rounded-2xl">
            此支柱尚無任何追蹤結構。<br/>點擊右上角新增分類 (Folder) 或項目 (Leaf)。
          </div>
        )}
        <div className="space-y-2">
          {pillar.nodes && pillar.nodes.map(node => (
            <TreeNode key={node.id} node={node} onAddChild={handleAddChild} onRemove={handleDelete} onUpdate={handleUpdateLeaf} />
          ))}
        </div>
      </div>
    </div>
  );
};

// 遞迴樹狀節點元件
const TreeNode = ({ node, onAddChild, onRemove, onUpdate, depth = 0 }) => {
  const [expanded, setExpanded] = useState(true);
  const isLeaf = node.type === 'leaf';

  return (
    <div className={`mt-2 ${depth > 0 ? 'ml-3 border-l-2 border-slate-100 pl-3' : ''}`}>
      <div className={`group flex items-center justify-between p-3 rounded-xl border ${isLeaf ? 'bg-white border-slate-100 shadow-sm' : 'bg-slate-50 border-transparent'} transition-colors`}>
        
        {/* 左側：名稱與展開/折疊 (如果是資料夾) */}
        <div className="flex items-center gap-2 flex-1">
          {!isLeaf && (
            <button onClick={() => setExpanded(!expanded)} className="text-slate-400 hover:text-slate-600">
              {expanded ? <ChevronDown size={16} /> : <ChevronRight size={16} />}
            </button>
          )}
          <span className={`font-bold ${isLeaf ? 'text-sm text-slate-800' : 'text-xs uppercase tracking-widest text-slate-500'}`}>{node.name}</span>
        </div>

        {/* 右側：操作區或數值區 */}
        <div className="flex items-center gap-3">
          {isLeaf ? (
            // 葉節點數值輸入區
            <div className="flex items-center gap-2">
              <input type="number" value={node.current} onChange={(e) => onUpdate(node.id, 'current', e.target.value)}
                className="w-14 bg-slate-100 p-1 rounded-md text-center font-mono text-xs border-none font-bold text-slate-900 focus:ring-1 focus:ring-slate-400" />
              <span className="text-slate-300 font-bold">/</span>
              <input type="number" value={node.target} onChange={(e) => onUpdate(node.id, 'target', e.target.value)}
                className="w-14 bg-white border border-slate-100 p-1 rounded-md text-center font-mono text-xs text-slate-400 focus:ring-1 focus:ring-slate-400" />
              <span className="text-[9px] font-black uppercase text-slate-300 w-6 text-left">{node.unit}</span>
            </div>
          ) : (
            // 資料夾節點操作區 (Hover顯示)
            <div className="hidden group-hover:flex gap-1 opacity-60 hover:opacity-100 transition-opacity">
               <button onClick={() => onAddChild(node.id, 'folder')} className="p-1 bg-slate-200 rounded text-slate-700" title="子分類"><FolderPlus size={12}/></button>
               <button onClick={() => onAddChild(node.id, 'leaf')} className="p-1 bg-slate-800 text-white rounded" title="子項目"><FilePlus size={12}/></button>
            </div>
          )}
          {/* 刪除按鈕 */}
          <button onClick={() => onRemove(node.id)} className="text-slate-200 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity p-1"><Trash2 size={14}/></button>
        </div>
      </div>

      {/* 葉節點專屬：進度條 */}
      {isLeaf && (
        <div className="mt-1.5 h-1 w-full bg-slate-50 rounded-full overflow-hidden">
          <div className="h-full bg-slate-900 transition-all duration-300" style={{ width: `${Math.min(100, (node.current / Math.max(node.target, 0.001)) * 100)}%` }}></div>
        </div>
      )}

      {/* 子節點遞迴渲染 */}
      {!isLeaf && expanded && node.children && (
        <div className="mt-1">
          {node.children.map(child => (
            <TreeNode key={child.id} node={child} onAddChild={onAddChild} onRemove={onRemove} onUpdate={onUpdate} depth={depth + 1} />
          ))}
        </div>
      )}
    </div>
  );
};


// ==========================================
// 視圖五：執行切片 (Execution View) - 加入重複邏輯
// ==========================================
const ExecutionView = ({ tasks, user, generateId }) => {

  const addTask = async () => {
    const title = prompt('任務名稱 (例如: 睡前靜心冥想)');
    if (!title) return;
    const time = prompt('執行時段 (例如: 22:30)', '12:00');
    
    // 加入重複性選擇
    const recurringOptions = "輸入重複設定:\n1. 單次 (預設)\n2. 每天\n3. 每週 (特定日)";
    const recChoice = prompt(recurringOptions, '1');
    let recurring = 'none';
    if (recChoice === '2') recurring = 'daily';
    else if (recChoice === '3') recurring = 'weekly';

    await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'tasks'), {
      title, time: time || '', recurring, completed: false, createdAt: Date.now()
    });
  };

  const toggleTask = async (id, currentStatus) => {
    await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'tasks', id), { completed: !currentStatus });
  };

  const deleteTask = async (id) => {
    if(!confirm('確定刪除此任務？')) return;
    await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'tasks', id));
  };

  return (
    <div className="space-y-8 py-4">
      <header className="flex justify-between items-end">
        <div>
          <h1 className="text-2xl font-black">執行切片</h1>
          <p className="text-[10px] text-slate-400 mt-1 uppercase tracking-widest font-black">今日行動與任務流</p>
        </div>
        <button onClick={addTask} className="text-[10px] font-bold text-slate-900 px-3 py-1.5 bg-slate-100 rounded-lg">＋ 新增任務</button>
      </header>

      {/* AI 校準動態建議 (預留) */}
      <section className="rounded-3xl bg-slate-900 p-6 text-white shadow-xl relative overflow-hidden">
        <div className="relative z-10">
          <h4 className="mb-2 text-[10px] font-black uppercase tracking-widest text-slate-300">AI 狀態對齊預留區</h4>
          <p className="text-sm font-medium leading-relaxed">
            此區塊為 LLM 建議保留空間。未來 AI 將即時讀取您的「三大支柱樹狀資料」，自動重算今日任務並在此顯示建議。
          </p>
        </div>
        <div className="absolute right-[-20px] top-[-20px] opacity-10"><Settings size={100} /></div>
      </section>

      {/* 任務列表 */}
      <div className="space-y-6">
        {tasks.length === 0 && (
          <div className="text-center p-8 text-slate-400 text-sm border-2 border-dashed border-slate-200 rounded-3xl font-bold">
            今日尚未安排任務切片
          </div>
        )}

        {/* 按時間簡單排序顯示 */}
        {tasks.sort((a,b)=> (a.time||'').localeCompare(b.time||'')).map((t) => (
          <div key={t.id} className="relative flex gap-6 pl-4 group">
            <div className="absolute left-4 top-10 bottom-0 w-px bg-slate-100"></div>
            <div className="relative z-10 flex h-8 w-8 shrink-0 items-center justify-center rounded-full border-4 border-white bg-slate-50">
              <div className={`h-2 w-2 rounded-full ${t.completed ? 'bg-slate-900' : 'bg-slate-300'}`}></div>
            </div>
            
            <div className={`flex-1 rounded-3xl border border-slate-100 p-5 shadow-sm transition-all relative ${t.completed ? 'bg-slate-50 opacity-50' : 'bg-white'}`}>
              <button onClick={() => deleteTask(t.id)} className="absolute -right-2 -top-2 bg-slate-100 text-red-500 rounded-full p-1.5 hidden group-hover:block shadow-sm z-10">
                <Trash2 size={12} />
              </button>

              <div className="flex justify-between items-start">
                <div>
                  <div className="font-mono text-[10px] font-bold text-slate-500">{t.time || '未定時'}</div>
                  <h4 className={`font-bold ${t.completed ? 'line-through text-slate-500' : 'text-slate-800'}`}>{t.title}</h4>
                  <div className="flex gap-2 mt-1">
                    {t.recurring !== 'none' && (
                       <span className="text-[8px] font-black text-slate-600 bg-slate-200 px-1.5 py-0.5 rounded uppercase">
                         {t.recurring === 'daily' ? '每日重複' : '每週重複'}
                       </span>
                    )}
                  </div>
                </div>
                <button onClick={() => toggleTask(t.id, t.completed)} className={`rounded-full p-2 transition-colors ${t.completed ? 'bg-slate-900 text-white shadow-md' : 'bg-slate-50 text-slate-400 hover:bg-slate-200'}`}>
                  <Check size={16} />
                </button>
              </div>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
};